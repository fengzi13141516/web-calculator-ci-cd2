name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        cd src
        pip install -r requirements.txt pytest
    
    - name: Lint with flake8
      run: |
        cd src
        pip install flake8
        python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    
    - name: Run unit tests
      run: |
        cd src
        python -m pytest tests/unit/ -v --junitxml=test-results.xml
    
    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: src/test-results.xml
    
    - name: Display unit test summary
      run: |
        echo "=== å•å…ƒæµ‹è¯•ç»“æœ ==="
        if [ -f "src/test-results.xml" ]; then
          echo "æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ"
        else
          echo "æµ‹è¯•æŠ¥å‘Šæœªæ‰¾åˆ°"
        fi

  functional-test:
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        cd src
        pip install -r requirements.txt
    
    - name: Create functional test script
      run: |
        cat > functional_test.py << 'EOF'
        import requests
        import time
        import sys
        
        def wait_for_app(timeout=30):
            print("ç­‰å¾…åº”ç”¨å¯åŠ¨...")
            start_time = time.time()
            
            for i in range(timeout // 2):
                try:
                    response = requests.get("http://localhost:5000/health", timeout=2)
                    if response.status_code == 200:
                        print(f"åº”ç”¨å·²å¯åŠ¨ï¼ç­‰å¾…æ—¶é—´: {time.time() - start_time:.1f}ç§’")
                        return True
                except requests.exceptions.RequestException:
                    time.sleep(2)
                    if (i + 1) % 5 == 0:
                        print(f"ç­‰å¾…ä¸­... {i*2}ç§’")
            
            print(f"ç­‰å¾…è¶…æ—¶ï¼ˆ{timeout}ç§’ï¼‰ï¼Œåº”ç”¨æœªå¯åŠ¨")
            return False
        
        def run_tests():
            test_cases = [
                ("/health", "å¥åº·æ£€æŸ¥"),
                ("/add/10&5", "åŠ æ³•"),
                ("/subtract/10&5", "å‡æ³•"),
                ("/multiply/10&5", "ä¹˜æ³•"),
                ("/divide/10&5", "é™¤æ³•"),
            ]
            
            passed = 0
            failed = 0
            
            for endpoint, description in test_cases:
                print(f"\næµ‹è¯•: {description} ({endpoint})")
                
                try:
                    response = requests.get(f"http://localhost:5000{endpoint}", timeout=5)
                    
                    if response.status_code == 200:
                        print(f"  çŠ¶æ€ç : {response.status_code}")
                        print(f"  å“åº”: {response.text[:100]}...")
                        passed += 1
                    elif response.status_code == 400 and "divide/10&0" in endpoint:
                        print(f"  çŠ¶æ€ç : {response.status_code} (é¢„æœŸé”™è¯¯)")
                        print(f"  å“åº”: {response.text[:100]}...")
                        passed += 1
                    else:
                        print(f"  çŠ¶æ€ç : {response.status_code} (é¢„æœŸ200)")
                        failed += 1
                        
                except Exception as e:
                    print(f"  å¼‚å¸¸: {e}")
                    failed += 1
            
            print(f"\næµ‹è¯•ç»“æœ: é€šè¿‡={passed}, å¤±è´¥={failed}")
            return failed == 0
        
        def main():
            if not wait_for_app():
                sys.exit(1)
            
            if not run_tests():
                sys.exit(1)
            
            print("\næ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼")
            sys.exit(0)
        
        if __name__ == "__main__":
            main()
        EOF
        
        chmod +x functional_test.py
    
    - name: Start application
      run: |
        echo "å¯åŠ¨åº”ç”¨ç¨‹åº..."
        cd src
        python app.py > app.log 2>&1 &
        echo $! > app.pid
        echo "åº”ç”¨ç¨‹åºPID: $(cat app.pid)"
        
        sleep 10
        
        if ps -p $(cat app.pid) > /dev/null; then
          echo "åº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œ"
          head -20 app.log || echo "æ— æ—¥å¿—"
        else
          echo "åº”ç”¨ç¨‹åºå¯åŠ¨å¤±è´¥"
          cat app.log
          exit 1
        fi
    
    - name: Run functional tests
      run: |
        echo "è¿è¡ŒåŠŸèƒ½æµ‹è¯•..."
        python functional_test.py
    
    - name: Stop application
      if: always()
      run: |
        echo "åœæ­¢åº”ç”¨ç¨‹åº..."
        if [ -f "src/app.pid" ]; then
          pid=$(cat src/app.pid)
          echo "åœæ­¢è¿›ç¨‹: $pid"
          kill $pid 2>/dev/null || true
          sleep 2
        fi
        rm -f src/app.pid src/app.log

  build-and-push:
    runs-on: ubuntu-latest
    needs: functional-test
    permissions:
      contents: read
      packages: write
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ghcr.io/fengzi13141516/web-calculator-ci-cd2:latest
          ghcr.io/fengzi13141516/web-calculator-ci-cd2:${{ github.sha }}
        labels: |
          org.opencontainers.image.source=https://github.com/fengzi13141516/web-calculator-ci-cd2
    
    - name: Display build info
      run: |
        echo "âœ… Dockeré•œåƒæ„å»ºå¹¶æ¨é€å®Œæˆï¼"
        echo "ğŸ“¦ ä»“åº“åœ°å€: ghcr.io/fengzi13141516/web-calculator-ci-cd2"