name: CD Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy-to-vm:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Generate deployment package
      run: |
        mkdir -p deploy-package
        cp -r deployment/* deploy-package/
        
        echo "GITHUB_REPOSITORY=${{ github.repository }}" > deploy-package/.env
        echo "IMAGE_TAG=${{ github.sha }}" >> deploy-package/.env
        
        cat > deploy-package/deploy-simple.sh << 'EOF'
        #!/bin/bash
        echo "开始简易部署..."
        docker-compose -f docker-compose.prod.yml down || true
        export BLUE_IMAGE=ghcr.io/${{ github.repository }}:${{ github.sha }}
        export GREEN_IMAGE=ghcr.io/${{ github.repository }}:${{ github.sha }}
        docker-compose -f docker-compose.prod.yml up -d
        echo "部署完成! 等待服务启动..."
        sleep 20
        echo "测试服务..."
        curl -f http://localhost/health && echo "服务健康!" || echo "服务可能有问题"
        EOF
        
        chmod +x deploy-package/deploy-simple.sh
        tar -czf deploy-package.tar.gz deploy-package/
        echo "部署包已创建: deploy-package.tar.gz"
    
    - name: Upload deployment package
      uses: actions/upload-artifact@v4  # 已更新为 v4
      with:
        name: deploy-package
        path: deploy-package.tar.gz
    
    - name: Display deployment instructions
      run: |
        echo "========================================"
        echo "部署说明:"
        echo "========================================"
        echo "1. 下载部署包: deploy-package.tar.gz"
        echo "2. 在虚拟机上执行以下命令:"
        echo "   tar -xzf deploy-package.tar.gz"
        echo "   cd deploy-package"
        echo "   docker login ghcr.io -u YOUR_USERNAME -p YOUR_TOKEN"
        echo "   ./deploy-simple.sh"
        echo "3. 访问应用: http://虚拟机IP"
        echo "========================================"